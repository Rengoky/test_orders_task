# –î–ª—è —Ä–µ–≤—å—é–µ—Ä–∞ üë®‚Äçüíª

–ö—Ä–∞—Ç–∫–æ–µ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ –ø—Ä–æ–≤–µ—Ä–∫–µ —ç—Ç–æ–≥–æ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –∑–∞–¥–∞–Ω–∏—è.

## –ö—Ä–∞—Ç–∫–∞—è —Å–≤–æ–¥–∫–∞

**–ó–∞–¥–∞–Ω–∏–µ**: Orders v2 ‚Äî –†–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–∏–µ + –ü–ª–∞—Ç–µ–∂–∏ (Saga)  
**–°—Ç–∞—Ç—É—Å**: ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–æ  
**–ü–æ–ª–Ω–æ—Ç–∞**: 100% —Ç—Ä–µ–±—É–µ–º—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π + –±–æ–Ω—É—Å—ã  
**–ü–æ–∫—Ä—ã—Ç–∏–µ —Ç–µ—Å—Ç–∞–º–∏**: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã –¥–ª—è –≤—Å–µ—Ö –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –ø—É—Ç–µ–π  
**–ö–∞—á–µ—Å—Ç–≤–æ –∫–æ–¥–∞**: –ë–µ–∑ –æ—à–∏–±–æ–∫ –ª–∏–Ω—Ç–µ—Ä–∞, –∞–Ω–Ω–æ—Ç–∞—Ü–∏–∏ —Ç–∏–ø–æ–≤, –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

## –ë—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ (5 –º–∏–Ω—É—Ç)

### 1. –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ—Ä–≤–∏—Å
```bash
docker-compose up -d
sleep 10
curl http://localhost:8000/healthz
```

### 2. –ó–∞–ø—É—Å—Ç–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–µ—Å—Ç–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç
```bash
bash scripts/test_api.sh
```

–≠—Ç–æ –ø—Ä–æ–¥–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä—É–µ—Ç:
- ‚úÖ –°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–æ–≤ (–∞–¥–º–∏–Ω)
- ‚úÖ –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞ —Å –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å—é
- ‚úÖ –†–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞
- ‚úÖ –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å (–ø–æ–≤—Ç–æ—Ä–Ω—ã–π –∑–∞–ø—Ä–æ—Å ‚Üí —Ç–æ—Ç –∂–µ –∑–∞–∫–∞–∑)
- ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–æ—Ä–∫–µ—Ä–æ–º outbox
- ‚úÖ –°–∏–º—É–ª—è—Ü–∏—è –ø–ª–∞—Ç–µ–∂–∞
- ‚úÖ Health checks –∏ –º–µ—Ç—Ä–∏–∫–∏

### 3. –ó–∞–ø—É—Å—Ç–∏—Ç—å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã
```bash
# –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: –¢—Ä–µ–±—É–µ—Ç—Å—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ —Ç–µ—Å—Ç–æ–≤–æ–π –ë–î
# –°–º. tests/conftest.py –¥–ª—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

pytest tests/integration/ -v
```

–û–∂–∏–¥–∞–µ—Ç—Å—è: 7 —Ç–µ—Å—Ç–æ–≤ –ø—Ä–æ–π–¥–µ–Ω–æ

## –ö–ª—é—á–µ–≤—ã–µ –º–æ–º–µ–Ω—Ç—ã —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

### 1. –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å ‚úÖ
**–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ**: `app/services/order_service.py:_compute_request_hash()`

- –•–µ—à –∑–∞–ø—Ä–æ—Å–∞ –≤—ã—á–∏—Å–ª—è–µ—Ç—Å—è –∏–∑ email + items
- –•—Ä–∞–Ω–∏—Ç—Å—è –≤ —Ç–∞–±–ª–∏—Ü–µ `idempotency_keys`
- –¢–æ—Ç –∂–µ –∫–ª—é—á + —Ç–∞ –∂–µ –ø–æ–ª–µ–∑–Ω–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞ ‚Üí –≤–µ—Ä–Ω—É—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∑–∞–∫–∞–∑
- –¢–æ—Ç –∂–µ –∫–ª—é—á + –¥—Ä—É–≥–∞—è –ø–æ–ª–µ–∑–Ω–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞ ‚Üí 409 Conflict

**–¢–µ—Å—Ç**: `tests/integration/test_orders.py::test_create_order_with_idempotency`

### 2. –ö–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞–º–∏ ‚úÖ
**–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ**: `app/repositories/product_repository.py::get_by_ids_for_update()`

```python
select(Product).where(Product.id.in_(product_ids)).with_for_update()
```

- –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –Ω–∞ —É—Ä–æ–≤–Ω–µ —Å—Ç—Ä–æ–∫ —á–µ—Ä–µ–∑ `SELECT ... FOR UPDATE`
- –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ race conditions
- –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–æ —Å –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–º–∏ –∑–∞–ø—Ä–æ—Å–∞–º–∏

**–¢–µ—Å—Ç**: `tests/integration/test_concurrent_stock.py::test_concurrent_stock_reservation`

### 3. –ü–∞—Ç—Ç–µ—Ä–Ω Outbox ‚úÖ
**–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ**: `app/workers/outbox_worker.py`

- –°–æ–±—ã—Ç–∏—è –∑–∞–ø–∏—Å—ã–≤–∞—é—Ç—Å—è –≤ –ë–î –≤ —Ç–æ–π –∂–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
- –§–æ–Ω–æ–≤—ã–π –≤–æ—Ä–∫–µ—Ä —Å —ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–π –∑–∞–¥–µ—Ä–∂–∫–æ–π
- –õ–æ–≥–∏–∫–∞ –ø–æ–≤—Ç–æ—Ä–æ–≤: 1—Å, 2—Å, 4—Å, 8—Å, 16—Å
- Dead letter queue –ø–æ—Å–ª–µ 5 –ø–æ–ø—ã—Ç–æ–∫
- `SKIP LOCKED` –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –≤–æ—Ä–∫–µ—Ä–æ–≤

**–ö–ª—é—á–µ–≤–æ–π –º–µ—Ç–æ–¥**: `OutboxWorker._process_events()`

### 4. –ö–æ–º–ø–µ–Ω—Å–∞—Ü–∏—è Saga ‚úÖ
**–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ**: `app/services/payment_service.py::process_payment_webhook()`

**–£—Å–ø–µ—à–Ω—ã–π –ø—É—Ç—å**: reserved ‚Üí payment_pending ‚Üí paid

**–ü—É—Ç—å –ø—Ä–∏ –æ—à–∏–±–∫–µ (–∫–æ–º–ø–µ–Ω—Å–∞—Ü–∏—è)**:
```python
# –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ç–æ–≤–∞—Ä
for item in order.items:
    product.stock += item.quantity
# –û—Ç–º–µ–Ω–∏—Ç—å –∑–∞–∫–∞–∑
order.status = OrderStatus.CANCELED
```

**–¢–µ—Å—Ç**: `tests/integration/test_payment_webhook.py`

### 5. –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —á–∞—Å—Ç–æ—Ç—ã –∑–∞–ø—Ä–æ—Å–æ–≤ ‚úÖ
**–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ**: `app/core/rate_limiter.py`

- Redis sliding window
- 5 –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ –º–∏–Ω—É—Ç—É –Ω–∞ email (–Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è)
- Sorted set —Å –≤—Ä–µ–º–µ–Ω–Ω—ã–º–∏ –º–µ—Ç–∫–∞–º–∏
- –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç 429 –ø—Ä–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏ –ª–∏–º–∏—Ç–∞

### 6. –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å ‚úÖ

**–ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –∞–¥–º–∏–Ω–∞**: `app/core/security.py::verify_admin_secret()`
```python
def verify_admin_secret(x_admin_secret: str = Header(...)):
    if x_admin_secret != settings.admin_secret:
        raise HTTPException(401, "Invalid admin secret")
```

**Webhook HMAC**: `app/core/security.py::verify_webhook_signature()`
```python
def compute_hmac_signature(payload: str, secret: str) -> str:
    return hmac.new(secret.encode(), payload.encode(), sha256).hexdigest()
```

**–ü—Ä–∏–º–µ—Ä**: –ü–æ—Ç–æ–∫ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–∫–∞–∑–∞
1. `routers/orders.py::create_order()` - –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –≤—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ, –ø—Ä–æ–≤–µ—Ä—è–µ—Ç rate limit
2. `services/order_service.py::create_order()` - –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞, —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è
3. `repositories/order_repository.py::create()` - –æ–ø–µ—Ä–∞—Ü–∏—è —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö

### –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º–∏ ‚úÖ
**–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ**: `app/services/order_service.py::create_order()`

–ï–¥–∏–Ω–∞—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –≤–∫–ª—é—á–∞–µ—Ç:
1. –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ —Å—Ç—Ä–æ–∫ –ø—Ä–æ–¥—É–∫—Ç–æ–≤
2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è —Ç–æ–≤–∞—Ä–∞
3. –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞ + —ç–ª–µ–º–µ–Ω—Ç–æ–≤
4. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞
5. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–ª—é—á–∞ –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏
6. –ó–∞–ø–∏—Å—å —Å–æ–±—ã—Ç–∏—è –≤ outbox

**–û—Ç–∫–∞—Ç –ø—Ä–∏ –ª—é–±–æ–π –æ—à–∏–±–∫–µ**

## –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞—á–µ—Å—Ç–≤–∞ –∫–æ–¥–∞

### –ë–µ–∑ –æ—à–∏–±–æ–∫ –ª–∏–Ω—Ç–µ—Ä–∞ ‚úÖ
```bash
ruff check app/ tests/
# –û–∂–∏–¥–∞–µ—Ç—Å—è: –ë–µ–∑ –æ—à–∏–±–æ–∫
```

### –ê–Ω–Ω–æ—Ç–∞—Ü–∏–∏ —Ç–∏–ø–æ–≤ ‚úÖ
```bash
mypy app/
# –û–∂–∏–¥–∞–µ—Ç—Å—è: –£—Å–ø–µ—Ö (—Å –Ω–µ–∫–æ—Ç–æ—Ä—ã–º–∏ –∏–≥–Ω–æ—Ä–∞–º–∏ –≤–Ω–µ—à–Ω–∏—Ö –±–∏–±–ª–∏–æ—Ç–µ–∫)
```

### –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ ‚úÖ
```bash
black --check app/ tests/

**–í—Å–µ–≥–æ**: 7 –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤, –ø–æ–∫—Ä—ã–≤–∞—é—â–∏—Ö –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—É—Ç–∏

### –ü–æ–º–∏–º–æ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π:
1. ‚úÖ **–ö–æ—Ä—Ä–µ–ª—è—Ü–∏—è Request ID** - –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤ —á–µ—Ä–µ–∑ –ª–æ–≥–∏
2. ‚úÖ **–ú–µ—Ç—Ä–∏–∫–∏ Prometheus** - orders_total, outbox_pending –∏ —Ç.–¥.
3. ‚úÖ **Health checks** - –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ë–î
4. ‚úÖ **–°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ JSON –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ** - –º–∞—à–∏–Ω–æ—á–∏—Ç–∞–µ–º—ã–µ –ª–æ–≥–∏
5. ‚úÖ **Makefile** - —É–¥–æ–±–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã
6. ‚úÖ **–°–∫—Ä–∏–ø—Ç –¥–ª—è seed –¥–∞–Ω–Ω—ã—Ö** - –±—ã—Å—Ç—Ä–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞
7. ‚úÖ **–¢–µ—Å—Ç–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç API** - –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
8. ‚úÖ **–ü–æ–¥—Ä–æ–±–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è** - 6 markdown —Ñ–∞–π–ª–æ–≤

### –ù–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):
- OpenTelemetry —Ç—Ä–µ–π—Å–∏–Ω–≥ (—É–ø–æ–º—è–Ω—É—Ç–æ –≤ README –∫–∞–∫ –±—É–¥—É—â–µ–µ —É–ª—É—á—à–µ–Ω–∏–µ)
- API —ç–Ω–¥–ø–æ–∏–Ω—Ç DLQ (dead —Å–æ–±—ã—Ç–∏—è –º–æ–∂–Ω–æ –∑–∞–ø—Ä–æ—Å–∏—Ç—å –ø—Ä—è–º–æ –≤ –ë–î)
- Feature flags (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø—Ä–æ—Å—Ç–∞—è boolean –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è)
- –°–∫—Ä–∏–ø—Ç—ã –Ω–∞–≥—Ä—É–∑–æ—á–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è (—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –≥–æ—Ç–æ–≤–∞, –Ω–µ –ø—Ä–∏–æ—Ä–∏—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–æ)

